<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>MAP</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <style>
        path {
            fill: none;
            stroke-width: 1px;
            stroke: #222;
        }
        .province:hover {
            fill: #666;
        }
        .hidden {
            display: none;
        }
        div.tooltip {
            color: #222;
            background-color: #fff;
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            opacity: 0.9;
            position: absolute;
        }

        .axis--x path {
            display: none;
        }

        .hot {
            fill: none;
            stroke: red;
            stroke-width: 1.5px;
        }

        .cold {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }
        .avg {
            fill: none;
            stroke: orange;
            stroke-width: 1.5px;
        }

        .freeze {
            fill: none;
            stroke: black;
            stroke-width: 1.5px;
        }
        .foo {
            position: fixed;
            bottom: 0;
            right: 0;
        }
    </style>
</head>
<body >
<svg width="1000" height="600">
    <g id="mapLayer"></g>
    <g id="cityLayer"></g>
    <g id="barchart"></g>g>
</svg>

<script type="text/javascript">
    {
        //set the dimensions and margins of the graph
        var margin = {top: 10, right: 20, bottom: 30, left: 50},
            line_width = 460 - margin.left - margin.right,
            line_height = 300 - margin.top - margin.bottom;

// parse the date / time

        var parseTime = d3.timeParse("%y%b%d");

// set the ranges
        var x = d3.scaleLinear().range([0, line_width]);
        var y = d3.scaleLinear().range([line_height, 0]);

// define the line
        var max = d3.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.TMAX); });

        var min = d3.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.TMIN); });

        var avg = d3.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.TAVG); });

        var svg_line = d3.select("body").append("svg")
                    .attr("width", line_width + margin.left + margin.right)
                    .attr("height", line_height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")"); 
        //var bar_chart = d3.select("#barchart").append("svg");
        var barchart= d3.select("body").append("svg")
                .attr("width", line_width + margin.left + margin.right)
                .attr("height", line_height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");             

        let svg = d3.select("svg");
        let width = parseInt(svg.attr("width"));
        let height = parseInt(svg.attr("height"));
        let projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2])
            .scale([800]);
        let path = d3.geoPath().projection(projection);
        // Load in GeoJSON data
        d3.json("us-states.json", function (json) {
            d3.select("#mapLayer").selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("fill","#ADD8E6");
        });
        var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');
        d3.csv("data.csv", function (data) {
            d3.select("#cityLayer").selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[0];
                })
                .attr("cy", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[1];
                })
                .attr("r", 5)
                .style("fill", "#FF0000")
                .style("opacity", 0.8)
                .on('mousemove', function (d) {
                    var mouse = d3.mouse(svg.node()).map(function (d) {
                        return parseInt(d);
                    })
                    tooltip.classed('hidden', false)
                        .attr('style', 'left:' + (mouse[0] + 15) +
                            'px; top:' + (mouse[1] - 35) + 'px')
                        .html(d.STATION_NAME);
                })
                .on('mouseout', function () {
                    tooltip.classed('hidden', true);
                })
                .on("click", function(d){
                    var data_list=[];
                        data.forEach(function(element){
                            if(element.STATION_NAME==d.STATION_NAME)
                                data_list.push(element);
                        }); 
                // append the svg obgect to the body of the page
                // appends a 'group' element to 'svg'
                // moves the 'group' element to the top left margin
                    line_chart(data_list);
                    bar_chart(data_list);
                   

                });
    });

  function line_chart(data_list)
  {             
                    data_list.forEach(function(d,i) {
                    if(d.STATION_NAME === "TAO NM US") {
                        d.push(d);
                        console.log(d)
                    }});

                //console.log(data);
                data_list.forEach(function(d) {
                    d.TMAX = +d["DLY-TMAX-NORMAL"];
                    d.TMIN = +d["DLY-TMIN-NORMAL"];
                    d.TAVG = +d["DLY-TAVG-NORMAL"];
                    d.date = d.DATE.slice(0, -2);
                    d.date = +d.date.slice(3);
                });

                // Scale the range of the data
                x.domain([0, d3.max(data_list, function(d) { return d.date; })]);
                y.domain([-20, d3.max(data_list, function(d) { return d.TMAX; })]);
                svg_line.append("path")
                    .data([data_list])
                    .attr("class", "hot")
                    .attr("d", max);

                svg_line.append("path")
                    .data([data_list])
                    .attr("class", "cold")
                    .attr("d", min);

                svg_line.append("path")
                    .data([data_list])
                    .attr("class", "avg")
                    .attr("d", avg);

                // Add the X Axis
                svg_line.append("g")
                    .attr("transform", "translate(0," + line_height + ")")
                    .call(d3.axisBottom(x));

                // Add the Y Axis
                svg_line.append("g")
                    .call(d3.axisLeft(y));

                svg_line.append("line")
                    .attr("x1",0)
                    .attr("x2",line_width)
                    .attr("y1",y(32))
                    .attr("y2",y(32))
                    .attr("class","freeze");
  }

function bar_chart(data_list)
{

        data_list.forEach(function(d) {

            d.TMAX = +d["DLY-TMAX-NORMAL"];
            d.TMIN = +d["DLY-TMIN-NORMAL"];
            d.TAVG = +d["DLY-TAVG-NORMAL"];
            d.TSNOW = +d["YTD-SNOW-NORMAL"];
            d.date = d.DATE.slice(0, -2);
            d.date = +d.date.slice(3);

        });

        // Scale the range of the data
        x.domain([0, d3.max(data_list, function(d) { return d.date; })]);
        y.domain([0, d3.max(data_list, function(d) { return d.TSNOW; })]);

        var Bar = barchart.selectAll("rect")
                    .remove().exit()
                    .data(data_list);
         Bar.enter().append("rect")
            .attr("class", "hot")
            .attr("x", function(d,i){return i})
            .attr("y", 0)
            .attr("height", function(d,i){return y(d.TSNOW)})
            .attr("width", function(d,i){return line_width/5000});

        // Add the X Axis
        barchart.append("g")
            .attr("class","x-axis")
            .attr("transform", "translate(0," + line_height + ")")
            .call(d3.axisBottom(x));

        // Add the Y Axis
        barchart.append("g")
            .attr("class","y-axis")
            .call(d3.axisLeft(y));

}


  }          
</script>
</body>
</html>