<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>MAP</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
    <style>
        path {
            fill: none;
            stroke-width: 1px;
            stroke: #222;
        }
        .province:hover {
            fill: #666;
        }
        .hidden {
            display: none;
        }
        div.tooltip {
            color: #222;
            background-color: #fff;
            padding: .5em;
            text-shadow: #f5f5f5 0 1px 0;
            border-radius: 2px;
            opacity: 0.9;
            position: absolute;
        }

        .axis--x path {
            display: none;
        }

        .hot {
            fill: none;
            stroke: red;
            stroke-width: 1.5px;
        }

        .cold {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }
        .avg {
            fill: none;
            stroke: orange;
            stroke-width: 1.5px;
        }

        .freeze {
            fill: none;
            stroke: black;
            stroke-width: 1.5px;
        }
        .foo {
            position: fixed;
            bottom: 0;
            right: 0;
        }
        .font{
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        .ticks {
            font: 10px sans-serif;
        }

        .track,
        .track-inset,
        .track-overlay {
            stroke-linecap: round;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #ddd;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            stroke: transparent;
            cursor: crosshair;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }
    </style>
</head>
<body >
<svg width="1200" height="1000" id="Map">
    <g id="mapLayer"></g>
    <g id="cityLayer"></g>
    <g id="barchart"></g>g>
</svg>

<script type="text/javascript">
    {
        //set the dimensions and margins of the graph
        var margin = {top: 10, right: 20, bottom: 30, left: 50},
            line_width = 460 - margin.left - margin.right,
            line_height = 300 - margin.top - margin.bottom;

// set the ranges
        var x = d3.scaleLinear().range([0, line_width]);
        var y = d3.scaleLinear().range([line_height, 0]);

// define the line
        var max = d3.line()
            .x(function (d) {
                return x(d.date);
            })
            .y(function (d) {
                return y(d.TMAX);
            });

        var min = d3.line()
            .x(function (d) {
                return x(d.date);
            })
            .y(function (d) {
                return y(d.TMIN);
            });

        var avg = d3.line()
            .x(function (d) {
                return x(d.date);
            })
            .y(function (d) {
                return y(d.TAVG);
            });

        var svg_line = d3.select("#Map").append("svg")
            .attr("width", line_width + margin.left + margin.right)
            .attr("height", line_height + margin.top + margin.bottom)
            .attr("x",600)
            .attr("y",500)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        var barchart = d3.select("#Map").append("svg")
            .attr("width", line_width + margin.left + margin.right)
            .attr("height", line_height + margin.top + margin.bottom)
            .attr("x",0)
            .attr("y",500)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        let svg = d3.select("svg");
        let width = parseInt(svg.attr("width"));
        let height = parseInt(svg.attr("height"));
        let projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2-250])
            .scale([800]);
        let path = d3.geoPath().projection(projection);
        // Load in GeoJSON data
        d3.json("us-states.json", function (json) {
            d3.select("#mapLayer").selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("fill", "#ADD8E6");
        });
        var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');

        d3.csv("data.csv", function (data) {
            d3.select("#cityLayer").selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[0];
                })
                .attr("cy", function (d) {
                    return projection([d.LONGITUDE, d.LATITUDE])[1];
                })
                .attr("r", 5)
                .style("fill", "#FF0000")
                .style("opacity", 0.8)
                .on('mousemove', function (d) {
                    var mouse = d3.mouse(svg.node()).map(function (d) {
                        return parseInt(d);
                    })
                    tooltip.classed('hidden', false)
                        .attr('style', 'left:' + (mouse[0] + 15) +
                            'px; top:' + (mouse[1] - 35) + 'px')
                        .html(d.STATION_NAME);
                })
                .on('mouseout', function () {
                    tooltip.classed('hidden', true);
                })
                .on("click", function (d) {
                    var data_list = [];
                    data.forEach(function (element) {
                        if (element.STATION_NAME == d.STATION_NAME)
                            data_list.push(element);
                    });
                    // append the svg obgect to the body of the page
                    // appends a 'group' element to 'svg'
                    // moves the 'group' element to the top left margin
                    line_chart(data_list);
                    bar_chart(data_list);
                    temp_slider(data_list);
                    //var animal_data;
                    d3.csv("Animal1.csv", function (error, animal_data) {
                        if (error) throw error;
                        animal(data_list, animal_data);
                        skipic();
                        animallist(data_list, animal_data);
                    });

                });
        });

        function line_chart(data_list) {
            data_list.forEach(function (d, i) {
                if (d.STATION_NAME === "TAO NM US") {
                    d.push(d);
                    console.log(d)
                }
            });

            //console.log(data);
            data_list.forEach(function (d) {
                d.TMAX = +d["DLY-TMAX-NORMAL"];
                d.TMIN = +d["DLY-TMIN-NORMAL"];
                d.TAVG = +d["DLY-TAVG-NORMAL"];
                d.date = d.DATE.slice(0, -2);
                d.date = +d.date.slice(3);
            });

            // Scale the range of the data
            x.domain([0, d3.max(data_list, function (d) {
                return d.date;
            })]);
            y.domain([-20, d3.max(data_list, function (d) {
                return d.TMAX;
            })]);
            svg_line.append("path")
                .data([data_list])
                .attr("class", "hot")
                .attr("d", max);

            svg_line.append("path")
                .data([data_list])
                .attr("class", "cold")
                .attr("d", min);

            svg_line.append("path")
                .data([data_list])
                .attr("class", "avg")
                .attr("d", avg);

            // Add the X Axis
            svg_line.append("g")
                .attr("transform", "translate(0," + line_height + ")")
                .call(d3.axisBottom(x));

            // Add the Y Axis
            svg_line.append("g")
                .call(d3.axisLeft(y));

            svg_line.append("line")
                .attr("x1", 0)
                .attr("x2", line_width)
                .attr("y1", y(32))
                .attr("y2", y(32))
                .attr("class", "freeze");
        }

        function bar_chart(data_list) {

            data_list.forEach(function (d) {

                d.TMAX = +d["DLY-TMAX-NORMAL"];
                d.TMIN = +d["DLY-TMIN-NORMAL"];
                d.TAVG = +d["DLY-TAVG-NORMAL"];
                d.TSNOW = +d["YTD-SNOW-NORMAL"];
                d.date = d.DATE.slice(0, -2);
                d.date = +d.date.slice(3);

            });

            // Scale the range of the data
            x.domain([0, d3.max(data_list, function (d) {
                return d.date;
            })]);
            y.domain([0, d3.max(data_list, function (d) {
                return d.TSNOW;
            })]);

            var Bar = barchart.selectAll("rect")
                .remove().exit()
                .data(data_list);
            Bar.enter().append("rect")
                .attr("class", "cold")
                .attr("x", function (d, i) {
                    return line_width - x(d.date)
                })
                .attr("y", function (d) {
                    return line_height - y(d.TSNOW)
                })
                .attr("height", function (d, i) {
                    return y(d.TSNOW)
                })
                .attr("width", function (d, i) {
                    return line_width / 12
                });

            // Add the X Axis
            barchart.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + line_height + ")")
                .call(d3.axisBottom(x));

            // Add the Y Axis
            barchart.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(y));

        }

        function animal(data_list, animal_data) {
            var pika_list = [];
            animal_data.forEach(function (element) {
                if (element.MSW05_Binomial == "Ochotona princeps")
                    pika_list.push(element);
            });

            /* if((data_list.STATION_NAME=="SILVER LAKE BRIGHTON UT US")||(data_list.STATION_NAME=="PINEVIEW DAM UT US")) */


            var svg2 = d3.select("#Map");


            var g = svg2.append("g");

            var img = g.append("svg:image")
                .attr("xlink:href", "pika.jpg")
                .attr("width", 300)
                .attr("height", 300)
                .attr("x", 0)
                .attr("y", 0);
            console.log(pika_list);
        }

        function skipic(data_list, animal_data) {

            /* if((data_list.STATION_NAME=="SILVER LAKE BRIGHTON UT US")||(data_list.STATION_NAME=="PINEVIEW DAM UT US")) */


            var svg2 = d3.select("#Map");


            var g = svg2.append("g");

            var img = g.append("svg:image")
                .attr("xlink:href", "Jackson.jpg")
                .attr("width", 300)
                .attr("height", 300)
                .attr("x", 900)
                .attr("y", 0);
        }

        function animallist(data_list, animal_data) {
        console.log(animal_data);
        console.log(data_list);

            var pika_list = [];
            animal_data.forEach(function (element) {
                if (element.MSW05_Binomial == "Ochotona princeps")
                    pika_list.push(element);
            });

            var svg2 = d3.select("#Map");

            var s = svg2.append("svg")
                .attr("x", 0)
                .attr("y", 300)
                .attr("width", 300)
                .attr("height", 300);

            var options = {
                valueNames: [ 'name', 'city' ]
            };

            var hackerList = new List('hacker-list', options);

        }
        function temp_slider(data_list) {

            var svg = d3.select("#Map"),
                margin = {right: 50, left: 50},
                width = +svg.attr("width") - margin.left - margin.right,
                height = +svg.attr("height");

            var x = d3.scaleLinear()
                .domain([-10, 10])
                .range([0, width])
                .clamp(true);

            var slider = svg.append("g")
                .attr("class", "slider")
                .attr("transform", "translate(" + margin.left + "," + height * 6 / 7 + ")");

            slider.append("line")
                .attr("class", "track")
                .attr("x1", x.range()[0])
                .attr("x2", x.range()[1])
                .select(function () {
                    return this.parentNode.appendChild(this.cloneNode(true));
                })
                .attr("class", "track-inset")
                .select(function () {
                    return this.parentNode.appendChild(this.cloneNode(true));
                })
                .attr("class", "track-overlay")
                .call(d3.drag()
                    .on("start.interrupt", function () {
                        slider.interrupt();
                    })
                    .on("start drag", function () {
                        hue(x.invert(d3.event.x));
                    }));

            slider.insert("g", ".track-overlay")
                .attr("class", "ticks")
                .attr("transform", "translate(0," + 18 + ")")
                .selectAll("text")
                .data(x.ticks(10))
                .enter().append("text")
                .attr("x", x)
                .attr("text-anchor", "middle")
                .text(function (d) {
                    return d + "°";
                });

            var handle = slider.insert("circle", ".track-overlay")
                .attr("class", "handle")
                .attr("r", 9);

            slider.transition() // Gratuitous intro!
                .duration(750)
                .tween("hue", function () {
                    var i = d3.interpolate(0, 7);
                    return function (t) {
                        hue(i(t));
                    };
                });

            function hue(h) {
                handle.attr("cx", x(h));
                svg.style("background-color", d3.hsl(h * 15, .7, .7));
            }
        }
    }
</script>
</body>
</html>